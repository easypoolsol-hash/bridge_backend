name: Unified CI/CD Pipeline

on:
  push:
    branches: [ develop, master ]
    tags:
      - 'v*.*.*'
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
      - '.gitignore'

permissions:
  contents: read
  packages: write
  id-token: write

env:
  IMAGE_NAME: bridge-api
  GCR_IMAGE: asia-south1-docker.pkg.dev/bridge-477812/bridge-repo/bridge-api

jobs:
  # ============================================================================
  # UNIFIED FLOW - CORRECT ORDER
  # ============================================================================
  # 1. Show path marker (which branch ‚Üí which environment)
  # 2. Quality checks (parallel - lint + mypy)
  # 3. Build image (tests need this!)
  # 4. Tests + Security + Smoke (all parallel using built image)
  # 5. Deploy to environment (three isolated deploy jobs)
  # ============================================================================

  # STEP 1: PATH MARKER - Shows which environment will be deployed
  show-path:
    name: üéØ PATH ‚Üí ${{ github.ref_name }} ‚Üí ${{ github.ref_name == 'develop' && 'DEV' || github.ref_name == 'master' && 'STAGING' || 'PRODUCTION' }}
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.detect.outputs.environment }}
      branch: ${{ steps.detect.outputs.branch }}
      is_tag: ${{ steps.detect.outputs.is_tag }}
    steps:
      - name: Detect and show deployment path
        id: detect
        run: |
          REF_NAME="${{ github.ref_name }}"
          REF_TYPE="${{ github.ref_type }}"

          # Big clear marker showing the path
          echo "‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì" >> $GITHUB_STEP_SUMMARY
          echo "‚îÉ                                                       ‚îÉ" >> $GITHUB_STEP_SUMMARY
          echo "‚îÉ   üéØ PIPELINE PATH MARKER                            ‚îÉ" >> $GITHUB_STEP_SUMMARY
          echo "‚îÉ                                                       ‚îÉ" >> $GITHUB_STEP_SUMMARY

          # Check if it's a tag (version tag triggers production)
          if [[ "$REF_TYPE" == "tag" ]]; then
            ENV="production"
            echo "‚îÉ   Tag: $REF_NAME    ‚Üí    Environment: PRODUCTION   ‚îÉ" >> $GITHUB_STEP_SUMMARY
            echo "is_tag=true" >> $GITHUB_OUTPUT
          else
            # It's a branch
            case "$REF_NAME" in
              develop)
                ENV="dev"
                echo "‚îÉ   Branch: develop    ‚Üí    Environment: DEV         ‚îÉ" >> $GITHUB_STEP_SUMMARY
                ;;
              master)
                ENV="staging"
                echo "‚îÉ   Branch: master     ‚Üí    Environment: STAGING     ‚îÉ" >> $GITHUB_STEP_SUMMARY
                ;;
              *)
                echo "‚îÉ   ‚ùå UNKNOWN BRANCH: $REF_NAME                      ‚îÉ" >> $GITHUB_STEP_SUMMARY
                echo "‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ" >> $GITHUB_STEP_SUMMARY
                exit 1
                ;;
            esac
            echo "is_tag=false" >> $GITHUB_OUTPUT
          fi

          echo "‚îÉ                                                       ‚îÉ" >> $GITHUB_STEP_SUMMARY
          echo "‚îó‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îõ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Flow:** Quality ‚Üí Build ‚Üí Tests + Security + Smoke (parallel) ‚Üí Deploy to $ENV" >> $GITHUB_STEP_SUMMARY

          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "branch=$REF_NAME" >> $GITHUB_OUTPUT

  # STEP 2: Quality checks (parallel - doesn't need image)
  quality:
    name: ‚úÖ Quality
    runs-on: ubuntu-latest
    needs: [show-path]
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/run-quality-checks

  # STEP 3: Build image FIRST (tests need this!)
  build:
    name: üèóÔ∏è Build Image
    runs-on: ubuntu-latest
    needs: [show-path, quality]
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/build-image
        with:
          image_tag: ${{ needs.show-path.outputs.environment }}

  # STEP 4: Tests using the built image (parallel matrix)
  tests:
    name: üß™ Test (${{ matrix.test-type }})
    runs-on: ubuntu-latest
    needs: [show-path, build]
    strategy:
      fail-fast: false
      matrix:
        test-type: [unit, integration, contract]
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/load-from-cache
        with:
          image_tag: ${{ needs.show-path.outputs.environment }}
          fail_if_missing: 'true'
      - uses: ./.github/actions/run-tests
        with:
          test_type: ${{ matrix.test-type }}
          image_name: ${{ env.IMAGE_NAME }}

  # STEP 4: Security scan (parallel with tests and smoke - all use built image)
  security:
    name: üîí Security
    runs-on: ubuntu-latest
    needs: [show-path, build]
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/load-from-cache
        with:
          image_tag: ${{ needs.show-path.outputs.environment }}
          fail_if_missing: 'true'
      - uses: ./.github/actions/run-security-scan
        with:
          image_name: ${{ env.IMAGE_NAME }}

  # STEP 4: Smoke tests (parallel with tests and security)
  smoke:
    name: üí® Smoke
    runs-on: ubuntu-latest
    needs: [show-path, build]
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/load-from-cache
        with:
          image_tag: ${{ needs.show-path.outputs.environment }}
          fail_if_missing: 'true'
      - uses: ./.github/actions/run-smoke-test
        with:
          image_name: ${{ env.IMAGE_NAME }}

  # ============================================================================
  # STEP 5: THREE ISOLATED DEPLOY BRANCHES (clear which one runs)
  # ============================================================================

  deploy-dev:
    name: üöÄ Deploy DEV
    runs-on: ubuntu-latest
    needs: [show-path, build, tests, security, smoke]
    if: |
      always() &&
      needs.show-path.outputs.environment == 'dev' &&
      needs.build.result == 'success' &&
      (needs.tests.result == 'success' || needs.tests.result == 'skipped') &&
      (needs.security.result == 'success' || needs.security.result == 'skipped') &&
      (needs.smoke.result == 'success' || needs.smoke.result == 'skipped')
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/load-from-cache
        with:
          image_tag: dev
          fail_if_missing: 'true'
      - uses: ./.github/actions/push-image
        with:
          image_tag: dev
          sha_tag_prefix: dev
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      - uses: ./.github/actions/deploy-cloudrun
        with:
          environment: dev
          image_tag: dev-${{ github.sha }}
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

  deploy-staging:
    name: üöÄ Deploy STAGING
    runs-on: ubuntu-latest
    needs: [show-path, build, tests, security, smoke]
    if: |
      always() &&
      needs.show-path.outputs.environment == 'staging' &&
      needs.build.result == 'success' &&
      (needs.tests.result == 'success' || needs.tests.result == 'skipped') &&
      (needs.security.result == 'success' || needs.security.result == 'skipped') &&
      (needs.smoke.result == 'success' || needs.smoke.result == 'skipped')
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/load-from-cache
        with:
          image_tag: staging
          fail_if_missing: 'true'
      - uses: ./.github/actions/push-image
        with:
          image_tag: staging
          sha_tag_prefix: staging
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      - uses: ./.github/actions/deploy-cloudrun
        with:
          environment: staging
          image_tag: staging-${{ github.sha }}
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

  deploy-production:
    name: üöÄ Deploy PRODUCTION
    runs-on: ubuntu-latest
    needs: [show-path, build, tests, security, smoke]
    if: |
      always() &&
      needs.show-path.outputs.environment == 'production' &&
      needs.build.result == 'success' &&
      (needs.tests.result == 'success' || needs.tests.result == 'skipped') &&
      (needs.security.result == 'success' || needs.security.result == 'skipped') &&
      (needs.smoke.result == 'success' || needs.smoke.result == 'skipped')
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/load-from-cache
        with:
          image_tag: production
          fail_if_missing: 'true'
      - uses: ./.github/actions/push-image
        with:
          image_tag: production
          sha_tag_prefix: production
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
      - uses: ./.github/actions/deploy-cloudrun
        with:
          environment: production
          image_tag: production-${{ github.sha }}
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}
